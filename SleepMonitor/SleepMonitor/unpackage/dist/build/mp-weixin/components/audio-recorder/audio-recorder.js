"use strict";const e=require("../../common/vendor.js"),t={name:"AudioRecorder",props:{isDarkTheme:{type:Boolean,default:!1}},data:()=>({isRecording:!1,recordingDuration:0,durationTimer:null,lastRecording:null,maxDuration:3e5,mediaRecorder:null,recorderManager:null,currentSize:0,options:{duration:3e5,sampleRate:44100,numberOfChannels:1,encodeBitRate:192e3,format:"mp3",frameSize:50}}),created(){this.initRecorderManager(),this.recorderManager?(this.recorderManager.onStop((e=>{console.log("录音结束:",e),this.isRecording=!1,this.recordingDuration=0,this.currentSize=0,clearInterval(this.durationTimer),this.lastRecording={tempFilePath:e.tempFilePath,duration:e.duration||this.recordingDuration,size:e.fileSize||this.currentSize,timestamp:(new Date).getTime()},this.saveRecordingFile(e.tempFilePath),this.$emit("recording-complete",this.lastRecording)})),this.recorderManager.onError((t=>{console.error("录音错误:",t),e.index.showToast({title:"录音出错: "+(t.errMsg||t.message||"未知错误"),icon:"none"}),this.isRecording=!1,this.recordingDuration=0,this.currentSize=0,clearInterval(this.durationTimer)})),this.recorderManager.onFrameRecorded((e=>{const{frameBuffer:t,isLastFrame:r}=e;t&&t.length>0&&(this.currentSize=Math.floor(this.recordingDuration/1e3*this.options.encodeBitRate/8))}))):console.warn("当前环境不支持录音功能")},methods:{initRecorderManager(){},async toggleRecording(){if(this.recorderManager)if(this.isRecording)this.recorderManager.stop();else try{await this.checkPermission()&&this.startRecording()}catch(t){console.error("权限检查失败:",t),e.index.showToast({title:"无法获取录音权限",icon:"none"})}else e.index.showToast({title:"当前环境不支持录音功能",icon:"none"})},checkPermission:async()=>new Promise(((e,t)=>{})),startRecording(){this.isRecording=!0,this.startTime=Date.now(),this.recordingDuration=0,this.currentSize=0,console.log("开始录音，时间戳:",this.startTime),this.durationTimer=setInterval((()=>{const e=Date.now(),t=e-this.startTime;console.log("当前时间:",e,"开始时间:",this.startTime,"时长:",t),this.recordingDuration=t,this.currentSize=Math.floor(t/1e3*this.options.encodeBitRate/8),t>=this.maxDuration&&this.recorderManager.stop()}),100)},async saveRecordingFile(t){try{(new Date).getTime();e.index.showToast({title:"录音已保存",icon:"success"})}catch(r){console.error("保存录音文件失败:",r),e.index.showToast({title:"保存录音失败",icon:"none"})}},formatTime(e){if("number"!=typeof e||isNaN(e))return"00:00";e=Math.floor(e);const t=Math.floor(e/1e3),r=Math.floor(t/60),i=t%60;if(isNaN(r)||isNaN(i))return"00:00";const o=`${String(r).padStart(2,"0")}:${String(i).padStart(2,"0")}`;return console.log("格式化结果:",o),o},formatFileSize:e=>e<1024?e+"B":e<1048576?(e/1024).toFixed(2)+"KB":(e/1048576).toFixed(2)+"MB",formatDate(e){const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}},beforeDestroy(){this.durationTimer&&clearInterval(this.durationTimer)}};const r=e._export_sfc(t,[["render",function(t,r,i,o,n,a){return e.e({a:n.isRecording?1:"",b:e.t(n.isRecording?"正在录音":"未开始录音"),c:n.isRecording?1:"",d:n.isRecording?1:"",e:e.o(((...e)=>a.toggleRecording&&a.toggleRecording(...e))),f:n.isRecording},n.isRecording?{g:e.t(a.formatTime(n.recordingDuration)),h:e.t(a.formatFileSize(n.currentSize))}:{},{i:i.isDarkTheme?1:""})}]]);wx.createComponent(r);
