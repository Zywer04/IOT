"use strict";const e=require("../../common/vendor.js"),s={data:()=>({messages:[],inputMessage:"",isLoading:!1,scrollTop:0,systemPrompt:"你是一个专业的睡眠顾问，具有丰富的睡眠医学知识。你的主要职责是：\n1. 解答用户关于睡眠的问题\n2. 提供改善睡眠质量的建议\n3. 解释睡眠相关的生理现象\n4. 在必要时建议用户就医\n\n请用专业但易懂的语言回答，并注意：\n- 保持友好和同理心\n- 不要给出具体的医疗诊断\n- 对于严重问题，建议及时就医\n- 回答要简洁明了，突出重点\n- 回答时不要用markdown格式来编辑字体加粗和标题等级，请用纯文本描述"}),onLoad(){this.messages.push({role:"assistant",content:"您好！我是您的AI睡眠顾问，请问有什么可以帮助您的吗？",time:this.formatTime(new Date)})},methods:{async sendMessage(){if(!this.inputMessage.trim()||this.isLoading)return;const s=this.inputMessage.trim();this.messages.push({role:"user",content:s,time:this.formatTime(new Date)}),this.inputMessage="",this.isLoading=!0,this.scrollToBottom();try{const e=await this.callAIAPI(s);this.messages.push({role:"assistant",content:e,time:this.formatTime(new Date)})}catch(t){console.error("API调用错误:",t);let s="抱歉，我遇到了一些问题，请稍后再试。";401===t.status?s="API密钥无效，请联系管理员。":402===t.status?(s="服务暂时不可用，请联系管理员充值或更换API密钥。",setTimeout((()=>{e.index.showModal({title:"服务提示",content:"当前API账户余额不足，无法继续提供服务。\n\n请联系管理员：\n1. 为当前账户充值\n2. 更换新的API密钥\n3. 使用其他AI服务提供商",showCancel:!1,confirmText:"我知道了"})}),500)):429===t.status?s="请求过于频繁，请稍后再试。":500===t.status&&(s="服务器错误，请稍后再试。"),this.messages.push({role:"assistant",content:s,time:this.formatTime(new Date)})}finally{this.isLoading=!1,this.scrollToBottom()}},async callAIAPI(s){var t;const a=await e.index.request({url:"https://api.deepseek.com/v1/chat/completions",method:"POST",header:{"Content-Type":"application/json",Authorization:"Bearer sk-dec348849b6f408c9fb451d14ec996ad"},data:{model:"deepseek-chat",messages:[{role:"system",content:this.systemPrompt},...this.messages.map((e=>({role:e.role,content:e.content}))),{role:"user",content:s}],temperature:.7,max_tokens:1e3}});if(200!==a.statusCode)throw{status:a.statusCode,message:(null==(t=a.data.error)?void 0:t.message)||"请求失败"};return a.data.choices[0].message.content.trim()},formatTime:e=>`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`,scrollToBottom(){setTimeout((()=>{this.scrollTop=9999999}),100)},loadMoreMessages(){console.log("加载更多消息")}}};const t=e._export_sfc(s,[["render",function(s,t,a,o,n,i){return e.e({a:e.f(n.messages,((s,t,a)=>({a:e.t(s.content),b:e.t(s.time),c:t,d:e.n("user"===s.role?"user-message":"ai-message")}))),b:n.isLoading},n.isLoading?{c:e.t(i.formatTime(new Date))}:{},{d:n.scrollTop,e:e.o(((...e)=>i.loadMoreMessages&&i.loadMoreMessages(...e))),f:e.o(((...e)=>i.sendMessage&&i.sendMessage(...e))),g:n.isLoading,h:n.inputMessage,i:e.o((e=>n.inputMessage=e.detail.value)),j:n.isLoading},(n.isLoading,{}),{k:e.o(((...e)=>i.sendMessage&&i.sendMessage(...e))),l:n.isLoading||!n.inputMessage.trim()})}]]);wx.createPage(t);
